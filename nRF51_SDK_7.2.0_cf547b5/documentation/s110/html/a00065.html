<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>nRF51 SDK - S110 SoftDevice: Init packet handling</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF51 SDK - S110 SoftDevice
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>API&#160;Reference</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('a00065.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Init packet handling </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>When updating the application on the chip, you can use an init packet in DFU to perform a safety check of the application image before it is transferred. This init packet provides a mechanism to include safety checks as part of the update procedure, so that a device accepts only compatible applications.</p>
<p>The init packet contains the following information that can be used for safety checks (see <a class="el" href="a00346.html">dfu_init_packet_t</a>):</p>
<ul>
<li>Device type: A 2-byte value specified by the developer that identifies the device type, for example Heart Rate Belt.</li>
<li>Device revision: A 2-byte value that can be used to restrict the update to be accepted only on devices with a defined revision number.</li>
<li>Application version: A 4-byte value identifying the version of the application that is being transferred. This value can be used to allow only software upgrades and prevent downgrades. No example code is provided for this feature.</li>
<li>Supported SoftDevices: A list of 2-byte values identifying the SoftDevices that are compatible with the application, for example S110 v7.0 and S110 v7.1.</li>
<li>Checksum: A 2-byte CRC-16-CCITT for the image to transfer.</li>
</ul>
<div class="image">
<img src="dfu_init_packet.png" alt="dfu_init_packet.png"/>
<div class="caption">
Figure 1: DFU Init packet</div></div>
<p> The nRF51 SDK provides a template, <code>dfu_init_template.c</code>, to perform safety checks of the init packet. This template can be used as starting point to develop procedures that increase the safety of DFU.</p>
<h1><a class="anchor" id="dfu_init_dev_rev_sec"></a>
Device and revision type</h1>
<p>The device and revision types can be stored in the user-reserved area of <code>UICR</code> (<code>0x10001080</code>) on the nRF51 chip. If this location is used for other purposes, update the offset <a class="el" href="a00947.html#ga7dbc00b26886d263bc3ff6fed3314df0">UICR_CUSTOMER_DEVICE_INFO_OFFSET</a> in <code>dfu_init.h</code> to match a free location in UICR.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define UICR_CUSTOMER_DEVICE_INFO_OFFSET    0x0                                             </span><span class="comment">/**&lt; Device info offset inside the customer UICR reserved area. Customers may change this value to place the device information in a user-preferred location. */</span><span class="preprocessor"></span></div>
</div><!-- fragment --><p> The default value in <code>UICR</code> is <code>0xFFFF</code>. If this value is present, any device and revision type provided in the init packet is accepted.</p>
<h1><a class="anchor" id="dfu_init_app_ver_sec"></a>
Application version</h1>
<p>The DFU init packet supports checking the application version. The current Bootloader/DFU example does not use this feature. However, you should implement an application version check if required. Add this check to <code>dfu_init_template.c</code>.</p>
<p>If you add an application version check, every application must be compiled with a version ID. This version ID should be placed at a predefined location in the application image, for example at the application start address + <code>0x0100</code>, similar to the principle used by Nordic SoftDevices.</p>
<p>See the following code snippet from <code>dfu_init_template.c</code>, which illustrates where to extend the DFU Init packet handling with an application version safety check:</p>
<div class="fragment"><div class="line">    <span class="comment">// In order to support application versioning this check should be updated.</span></div>
<div class="line">    <span class="comment">// This template allows for any application to be installed however customer could place a</span></div>
<div class="line">    <span class="comment">// revision number at bottom of application to be verified by bootloader. This could be done at</span></div>
<div class="line">    <span class="comment">// a relative location to this papplication for example Application start address + 0x0100.</span></div>
</div><!-- fragment --> <h1><a class="anchor" id="dfu_init_sd_list_sec"></a>
SoftDevice list</h1>
<p>Applications that are compiled for the nRF51 chip target a specific SoftDevice, for example S110 v7.1.0. Some applications might work with multiple SoftDevice versions if the API is backward compatible. For example, an application that is compiled for SoftDevice S110 v7.0.0 can also run on SoftDevice S110 v7.1.0.</p>
<p>You can provide a list of supported SoftDevices for the application that is to be installed in the DFU init packet. The DFU checks the list that is provided in the init packet against the currently installed SoftDevice on the chip and continues the update procedure only if a matching SoftDevice is installed.</p>
<p>A value of <code>0xFFFE</code> indicates that the application should be installed regardless of the SoftDevice that is present. This feature can be helpful during development, but you should not use it in a product.</p>
<p>See the following table for the <code>FWID</code> values of current SoftDevices:</p>
<table class="doxtable">
<tr>
<th>SoftDevice S110 </th><th><code>FWID</code> </th></tr>
<tr>
<td>S110 v7.0.0 </td><td><code>0x004F</code> </td></tr>
<tr>
<td>S110 v7.1.0 </td><td><code>0x005A</code> </td></tr>
<tr>
<td>Development/any </td><td><code>0xFFFE</code> </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="a00004.html">Examples</a></li><li class="navelem"><a class="el" href="a00062.html">BLE Bootloader/DFU</a></li>
    <li class="footer">Generated on Thu Jan 15 2015 09:02:16 for nRF51 SDK - S110 SoftDevice by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
