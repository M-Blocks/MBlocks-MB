<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>DFU Profile Specification</title>
<link href="tabs.css" rel="stylesheet" type="text/css" />
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="alias.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="alias.js"></script>
<script type="text/javascript" src="jquery.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/javascript">
  jQuery(document).ready(function () {
    if(gref){ // Number all _img and _table classes
      gref();
    }
  });
</script>
</head>
<body>
<div id="top"><!-- do not remove this div! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nordic_small.png"></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF51 SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Overview</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__dfu__ble__profile__spec.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">DFU Profile Specification<div class="ingroups"><a class="el" href="group__dfu__transport__ble.html">BLE</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<p>Example proprietary profile used to update firmware (application image) file using Bluetooth Low Energy. This is not a standard profile, and is defined by Nordic to demonstrate how a typical Device Firmware Update can be achieved.</p>
<h1><a class="anchor" id="ota_profile_section"></a>
Device Firmware Update Profile</h1>
<h2><a class="anchor" id="ota_profile_intro"></a>
Profile Dependencies</h2>
<p>The Device Firmware Update (DFU) Profile is used to transfer an application image from a BLE master (example, PC or Smart Phone) to a slave (example, Heart Rate Sensor) that supports Device Firmware Updates using the DFU Service.</p>
<h3><a class="anchor" id="ota_profile_intro"></a>
Profile Dependencies</h3>
<p>This profile requires the Generic Attribute Profile (GATT).</p>
<h2><a class="anchor" id="ota_profile_conf"></a>
Configuration</h2>
<h3><a class="anchor" id="ota_profile_roles"></a>
Roles</h3>
<p>The profile defines two roles: DFU Target and Client. The DFU Target is the device which receives an image from the DFU Controller.</p>
<ul>
<li>The DFU Target, implements a GATT Server. This is the device under update.</li>
<li>The DFU Controller, implements a GATT client. This will be the device that uploads a new firmware image to the DFU Target.</li>
</ul>
<h3><a class="anchor" id="ota_profile_role_service"></a>
Role/Service Relationships</h3>
<p>The following diagram shows the relationships between services and the two profile roles.</p>
<div class="image">
<img src="ota_roles_overview.png" alt="ota_roles_overview.png"/>
<div class="caption">
Relationship between profile roles and services</div></div>
<p> A DFU Target instantiates one instance of the DFU service.</p>
<h2><a class="anchor" id="ota_profile_updater_role_req"></a>
DFU Controller Role Requirements</h2>
<p>The DFU Controller shall support the <a class="el" href="group__dfu__ble__service__spec.html#ota_spec_sec">Device Firmware Update Service</a>.</p>
<table class="doxtable">
<tr>
<th>Service </th><th>DFU Controller</th></tr>
<tr>
<td>Device Firmware Update Service </td><td>M </td></tr>
</table>
<h3><a class="anchor" id="ota_profile_dfu_controller_err_handling"></a>
General Error Handling.</h3>
<p>The DFU Controller shall also be tolerant when receiving the following ATT Error Code defined in CSS Part B, Section 1.2 of Supplement to the Bluetooth Core Specification, Version 3 or later:</p>
<ul>
<li>Client Characteristic Configuration Descriptor Improperly Configured</li>
</ul>
<h3><a class="anchor" id="ota_profile_updater_role_transfering"></a>
DFU Image Transfer Procedure</h3>
<p>The DFU Controller requests one of the procedures defined for Device Firmware Update using the <em>DFU Control Point</em>. Each procedure requested by the Controller is characterised by a request on the DFU Control Point, using the GATT Write Procedure. This may be followed by additional writes on the DFU packet characteristic based, followed by end of procedure marked by a response from the DFU Target for the procedure using GATT Notifications on the Control Point. Response code in the response packet determines the success or failure of the procedure. In case of failure, the response codes provide an indication on possible reason for failure. Refer to the detailed description for more details in the <em>DFU Control Point</em>. The DFU Target process one request at a time, therefore if a request is received on the Target when already processing one, an ATT Error Response with 'Procedure Already In Progress' is received on the DFU Controller. Asynchronous Status and Image Size received information are sent by the DFU Target as GATT Notifications on the control point.</p>
<p>Below is small MSC to show a typical DFU Control Point Procedure</p>
<div class="image">
<img src="ota_dfu_typical_ctrl_pt_procedure.png" alt="ota_dfu_typical_ctrl_pt_procedure.png"/>
<div class="caption">
Typical DFU Control Point procedure</div></div>
<p> DFU Procedures defined are listed below:</p>
<table class="doxtable">
<tr>
<th>DFU Procedure </th><th>Description</th></tr>
<tr>
<td>Start DFU </td><td>Procedure to prepare the device for a uploading the firmware. Size of firmware is provided in the request parameter. DFU Target response determines the device is ready for next stage of firmware update. </td></tr>
<tr>
<td>Receive Init Data </td><td>Procedure to exchange information necessary for firmware update that needs to exchanged before upload of firmware. Hash exchange/ Public key Exchange etc are some examples of such information. </td></tr>
<tr>
<td>Receive App Data </td><td>Procedure to upload firmware fragmented as DFU Packets. Maximum size of each packet is (ATT_MTU - 3) octets. DFU Packets can be of variable length with a minimum size of 1 octet. </td></tr>
<tr>
<td>Validate </td><td>Procedure to validate updated firmware image. </td></tr>
<tr>
<td>Activate Image &amp; Reset </td><td>Procedure to activate the new firmware and restart the device with new firmware. This procedure results in a GAP Disconnect. </td></tr>
<tr>
<td>System Reset </td><td>Procedure to reset system. This procedure result in a GAP Disconnection Procedure. </td></tr>
<tr>
<td>Report Received Image Size </td><td>Procedure to request the size of image received. </td></tr>
<tr>
<td>Packet Receipt Notification</td><td>Procedure to request notification on receiving every 'n' packets. The number 'n' is requested by the controller. This is not a mandatory procedure for the Controller. </td></tr>
</table>
<p>DFU Target in DFU mode, is in <b>GAP General Discoverable mode</b> and is <b>connectable</b>. 128-bit DFU Service UUID is advertised in the Advertisement Data, along with full name of <b>DfuTarg</b>.</p>
<p>Once connected to the DFU Controller, DFU Procedure can be started by requesting a Start DFU Procedure. Size of new firmware is provided during this procedure. On successful <em>Start DFU</em> procedure, <em>Receive Init Data</em> is initiated to exchange CRC information. On success, this procedure is followed by upload of new firmware by requesting the <em>Receive App Data</em> Procedure. Currently, banked update is performed, implying, the old firmware can be restored in case firmware update procedure did not succeed at any stage of DFU Transfer. New firmware transferred is validated using the <em>Validate Procedure</em>. Validated firmware can be activated by issuing the <em>Activate Image &amp; Reset Procedure</em>. It is possible to reset the system at any stage using the <em>System Reset</em> procedure. When this procedure is requested, the system will restart with old firmware in case the device had a firmware; in case the device did not have any existing application firmware the system will restart in DFU mode.</p>
<p>Firmware being updated is expected in binary format. It is possible to request the size of received firmware by requesting the <em>Report Received Image Size</em> procedure. This procedure is particularly useful on reconnection after a link loss. See <a class="el" href="group__dfu__ble__profile__spec.html#ota_profile_ll_behavior">Link Loss Procedure</a> for more details. It is also possible for the Controller to request notification of acknowledge for every 'n' packets received using the <em>Packet Receipt Notification</em> procedure.</p>
<p>MSC below describes a typical firmware update exchange between a DFU Controller and DFU Target.</p>
<div class="image">
<img src="ota_dfu_transfer.png" alt="ota_dfu_transfer.png"/>
<div class="caption">
Transfer of an image to the DFU Target.</div></div>
 <h3><a class="anchor" id="ota_idle_mode_procedure"></a>
Idle Mode Procedures</h3>
<p>In case no connection is established with the DFU Target after 60 seconds, Target device will restart in normal mode with old firmware, in case there was an existing application, else in DFU mode, in case there was no application on the device.</p>
<h3><a class="anchor" id="ota_profile_idle_conn"></a>
Idle Connection Procedure</h3>
<p>When the Nordic bootloader application detects that the connection has been idle for a time period, meaning that the DFU Controller has not written any packet that will result in the progress of the firmware update, the update will be stopped, the connection will be terminated, and the previously valid application will be started. If no valid application exists in the flash, the application stays in bootloader mode waiting for a reconnection from the DFU Controller.</p>
<h3><a class="anchor" id="ota_profile_ll_behavior"></a>
Link Loss Procedure</h3>
<p>When the Nordic bootloader application detects a link loss, DFU state and image size is remembered. On reconnection to the Controller, the transfer can resume from where it had stopped. Controller can request size of received image using the <em>Report Received Image Size</em> Procedure and start transfer by applying the necessary offset. <a class="el" href="group__dfu__ble__profile__spec.html#ota_idle_mode_procedure">Idle Mode Procedures</a> apply in the disconnected state on link loss.</p>
<div class="image">
<img src="dfu_ota_link_loss.png" alt="dfu_ota_link_loss.png"/>
<div class="caption">
Recovery after Link Loss.</div></div>
 <h3><a class="anchor" id="ota_profile_pkt_rcpt_notif"></a>
Packet Receipt Notification procedure</h3>
<p>This feature allows the DFU Controller to subscribe for a notification from the DFU Target, each time a given number of firmware packets is received by the latter. To use this feature, the DFU Controller should write to the DFU Control Point, the Op Code 0x08 - <em>Packet Receipt Notification Request</em> followed by the <em>Number of packets</em>. If the <em>Number of packets</em> field is set to <em>N</em>, then the DFU Target will send a Notification of the DFU Control Point with Op Code = 0x11 - <em>Packet Receipt Notification</em>, each time it receives <em>N</em> number of firmware packets. The DFU Controller should wait for this notification each time it has finished sending <em>N</em> number of firmware packets.</p>
<p>In <em>Packet Receipt Notification</em>, the DFU Target also sends the number of bytes of firmware data received until that point of time. This may be used for any consistency checks by the DFU Controller.</p>
<div class="image">
<img src="dfu_ota_pkt_rcpt_notif_procedure.png" alt="dfu_ota_pkt_rcpt_notif_procedure.png"/>
<div class="caption">
Packet Receipt Notification procedure.</div></div>
<h1><a class="anchor" id="security_considerations"></a>
Security Considerations</h1>
<p>This section describes the security considerations for a DFU Target and DFU Controller.</p>
<h2><a class="anchor" id="ota_server_sec"></a>
DFU Target Security Considerations</h2>
<p>All supported characteristics specified by the DFU Service are set to Security Mode 1 and Security Level 1. </p>
</div><!-- contents -->
</div><!-- doc-content -->

    <li class="footer">
      Copyright &copy 2006-2013 <a href="http://www.nordicsemi.no" style="text-decoration:none">Nordic Semiconductor</a>.
      All Rights Reserved.
      <a href="disclaimer.html">Disclaimer</a>
    </li>
   </ul>
 </div>
</body>
</html>
